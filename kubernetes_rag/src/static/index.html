<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAG Chat</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a2e;color:#e0e0e0;height:100vh;display:flex;flex-direction:column}
header{background:#16213e;padding:12px 24px;border-bottom:1px solid #0f3460;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
header h1{font-size:18px;font-weight:600;color:#e94560}
header .badge{font-size:11px;background:#0f3460;color:#7ec8e3;padding:3px 8px;border-radius:10px}
.header-right{margin-left:auto;display:flex;align-items:center;gap:12px}
#stats{font-size:12px;color:#888}
.model-switcher{display:flex;align-items:center;gap:6px}
.model-switcher label{font-size:11px;color:#888;text-transform:uppercase;letter-spacing:.5px}
.model-switcher select{background:#0f3460;color:#7ec8e3;border:1px solid #1a3a6e;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer;outline:none}
.model-switcher select:hover{border-color:#e94560}
#chat-container{flex:1;overflow-y:auto;padding:20px 0;display:flex;flex-direction:column}
.message{max-width:780px;width:100%;margin:0 auto;padding:8px 24px;display:flex;gap:14px;line-height:1.6}
.message.user{background:transparent}
.message.assistant{background:#16213e;border-radius:8px;margin-top:4px;margin-bottom:4px}
.avatar{width:32px;height:32px;border-radius:6px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px;margin-top:4px}
.avatar.user-av{background:#533483}
.avatar.bot-av{background:#e94560}
.msg-body{flex:1;min-width:0}
.msg-body p{margin-bottom:8px}
.msg-body h2{font-size:16px;color:#e94560;margin:12px 0 6px}
.msg-body h3{font-size:14px;color:#7ec8e3;margin:10px 0 4px}
.msg-body ul,.msg-body ol{margin:4px 0 8px 20px}
.msg-body li{margin-bottom:4px}
.msg-body pre{background:#0d1117;padding:12px;border-radius:6px;overflow-x:auto;font-size:13px;margin:8px 0}
.msg-body code{font-family:'SF Mono',Consolas,monospace;font-size:13px}
.msg-body p code{background:#0d1117;padding:2px 5px;border-radius:3px}
/* Citation ref in answer text */
.cite-ref{display:inline-block;font-size:10px;background:#533483;color:#ddd;padding:0 4px;border-radius:4px;cursor:pointer;vertical-align:super;line-height:1;margin:0 1px;text-decoration:none}
.cite-ref:hover{background:#e94560;color:#fff}
/* Response meta bar */
.response-meta{display:flex;gap:14px;align-items:center;margin-top:10px;padding:6px 10px;background:#1a1a2e;border-radius:6px;font-size:11px;color:#888;flex-wrap:wrap}
.response-meta .meta-item{display:flex;align-items:center;gap:4px}
.response-meta .meta-label{color:#666}
.response-meta .meta-value{color:#7ec8e3}
/* Citations */
.citations{margin-top:12px;padding:10px 14px;background:#0f3460;border-radius:6px;font-size:13px}
.citations summary{cursor:pointer;color:#7ec8e3;font-weight:500}
.citation-item{padding:6px 0;border-bottom:1px solid #1a1a3e;display:flex;align-items:baseline;gap:8px;transition:background .2s}
.citation-item:last-child{border-bottom:none}
.citation-item.highlight{background:#533483;border-radius:4px;padding-left:6px}
.citation-score{font-size:11px;background:#533483;padding:1px 6px;border-radius:8px;color:#ddd;white-space:nowrap}
.citation-source{color:#7ec8e3;font-family:monospace;font-size:12px}
.citation-source a{color:#7ec8e3;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:3px}
.citation-source a:hover{color:#a8e0f7;text-decoration-style:solid}
.citation-source .no-link{opacity:.8}
.citation-section{color:#999;font-size:12px}
/* Benchmark comparison */
.benchmark-results{margin-top:12px;padding:12px;background:#0d1117;border-radius:8px;font-size:13px}
.benchmark-results h4{color:#e94560;margin-bottom:8px;font-size:14px}
.bench-entry{padding:8px 10px;background:#16213e;border-radius:6px;margin-bottom:6px}
.bench-entry:last-child{margin-bottom:0}
.bench-model-name{color:#7ec8e3;font-weight:600;font-size:13px;margin-bottom:4px}
.bench-stats{font-size:11px;color:#888;display:flex;gap:12px;margin-bottom:4px}
.bench-stats span{color:#7ec8e3}
.bench-answer{font-size:12px;color:#ccc;max-height:80px;overflow-y:auto;line-height:1.5}
.bench-summary{padding:8px 10px;background:#533483;border-radius:6px;font-size:12px;color:#ddd;margin-top:6px}
.bench-summary strong{color:#e94560}
/* Typing */
.typing{opacity:.6}
.typing .dot{display:inline-block;animation:blink 1.4s infinite}
.typing .dot:nth-child(2){animation-delay:.2s}
.typing .dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,20%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
/* Input area */
#input-area{background:#16213e;border-top:1px solid #0f3460;padding:16px}
#input-wrap{max-width:780px;margin:0 auto;display:flex;gap:8px;align-items:flex-end}
#input-wrap textarea{flex:1;background:#1a1a2e;border:1px solid #333;color:#e0e0e0;border-radius:10px;padding:12px 16px;font-size:14px;resize:none;font-family:inherit;line-height:1.5;max-height:120px;min-height:46px}
#input-wrap textarea:focus{outline:none;border-color:#e94560}
#input-wrap textarea::placeholder{color:#666}
.btn{border:none;color:white;height:42px;border-radius:10px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:background .2s;padding:0 14px}
#send-btn{background:#e94560;width:42px;font-size:18px;flex-shrink:0;padding:0}
#send-btn:hover{background:#c73e54}
#compare-btn{background:#533483;font-size:12px;white-space:nowrap}
#compare-btn:hover{background:#6b44a8}
.btn:disabled{background:#555!important;cursor:not-allowed}
.welcome{max-width:600px;margin:auto;text-align:center;padding:40px 20px}
.welcome h2{color:#e94560;margin-bottom:12px;font-size:24px}
.welcome p{color:#888;margin-bottom:20px}
.examples{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.examples button{background:#0f3460;border:1px solid #1a3a6e;color:#7ec8e3;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;transition:background .2s}
.examples button:hover{background:#1a3a6e}
</style>
</head>
<body>
<header>
  <h1>&#9889; RAG Chat</h1>
  <span class="badge">Kubernetes &bull; Docker &bull; DevOps</span>
  <div class="header-right">
    <div class="model-switcher">
      <label>Model</label>
      <select id="model-select"><option value="">Loading...</option></select>
    </div>
    <span id="stats">Loading...</span>
  </div>
</header>
<div id="chat-container">
  <div class="welcome" id="welcome">
    <h2>Ask anything about DevOps</h2>
    <p>Powered by embeddings + reranking with citation grounding</p>
    <div class="examples">
      <button onclick="askExample(this)">What is a Kubernetes Pod?</button>
      <button onclick="askExample(this)">How does scheduling work in K8s?</button>
      <button onclick="askExample(this)">Docker networking basics</button>
      <button onclick="askExample(this)">What is etcd used for?</button>
    </div>
  </div>
</div>
<div id="input-area">
  <div id="input-wrap">
    <textarea id="input" rows="1" placeholder="Ask a question..." autofocus></textarea>
    <button class="btn" id="send-btn" onclick="send()">&#10148;</button>
    <button class="btn" id="compare-btn" onclick="compareModels()">Compare</button>
  </div>
</div>
<script>
var chatContainer=document.getElementById('chat-container'),
    inputEl=document.getElementById('input'),
    sendBtn=document.getElementById('send-btn'),
    compareBtn=document.getElementById('compare-btn'),
    welcome=document.getElementById('welcome'),
    statsEl=document.getElementById('stats'),
    modelSelect=document.getElementById('model-select'),
    currentModel=null;

inputEl.addEventListener('input',function(){inputEl.style.height='auto';inputEl.style.height=Math.min(inputEl.scrollHeight,120)+'px'});
inputEl.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}});

fetch('/stats').then(function(r){return r.json()}).then(function(d){statsEl.textContent=d.document_count+' docs indexed'}).catch(function(){statsEl.textContent=''});

fetch('/models').then(function(r){return r.json()}).then(function(d){
  modelSelect.innerHTML='';
  var cur=d.current||d.default;
  (d.models||[]).forEach(function(m){
    var o=document.createElement('option');o.value=m.id;o.textContent=m.name;o.dataset.provider=m.provider;
    if(m.id===cur)o.selected=true;
    modelSelect.appendChild(o);
  });
  currentModel=cur;
}).catch(function(){modelSelect.innerHTML='<option value="">Unavailable</option>'});

modelSelect.addEventListener('change',function(){currentModel=modelSelect.value});

function askExample(btn){inputEl.value=btn.textContent;send()}

function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML}

function addMsg(role,html){
  if(welcome)welcome.style.display='none';
  var u=role==='user',div=document.createElement('div');
  div.className='message '+role;
  div.innerHTML='<div class="avatar '+(u?'user-av':'bot-av')+'">'+(u?'&#128100;':'&#9889;')+'</div><div class="msg-body">'+html+'</div>';
  chatContainer.appendChild(div);chatContainer.scrollTop=chatContainer.scrollHeight;
  return div;
}

function showTyping(){
  return addMsg('assistant','<span class="typing"><span class="dot">&#9679;</span> <span class="dot">&#9679;</span> <span class="dot">&#9679;</span></span>');
}

function fmtMd(text){
  text=text.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code>$2</code></pre>');
  text=text.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  text=text.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  text=text.replace(/^- (.+)$/gm,'<li>$1</li>');
  text=text.replace(/(<li>[^]*?<\/li>\n?)+/g,function(m){return '<ul>'+m+'</ul>'});
  text=text.replace(/`([^`]+)`/g,'<code>$1</code>');
  text=text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  // Convert [Source N], [Document N], and comma-separated variants to clickable citation badges
  // Comma-separated FIRST: [Source 1, Source 2, 3] or [Document 1, Document 2, Document 3] or [Source 1, 2, 3]
  text=text.replace(/\[(?:Source|Document)\s*\d+(?:\s*,\s*(?:(?:Source|Document)\s*)?\d+)+\]/gi,function(match){
    var nums=match.match(/\d+/g);
    if(!nums)return match;
    var seen={};
    return nums.filter(function(n){if(seen[n])return false;seen[n]=true;return true}).map(function(n){
      return '<a class="cite-ref" data-cite="'+n+'" onclick="hlCite('+n+')" title="Jump to source #'+n+'">S'+n+'</a>';
    }).join(' ');
  });
  // Single refs: [Source 1] or [Document 1]
  text=text.replace(/\[(?:Source|Document)\s*(\d+)\]/gi,function(_,n){
    return '<a class="cite-ref" data-cite="'+n+'" onclick="hlCite('+n+')" title="Jump to source #'+n+'">S'+n+'</a>';
  });
  text=text.replace(/\n{2,}/g,'</p><p>');
  text=text.replace(/\n/g,'<br>');
  return '<p>'+text+'</p>';
}

function hlCite(n){
  var el=document.querySelector('.citation-item[data-cite-id="'+n+'"]');
  if(!el)return;
  el.scrollIntoView({behavior:'smooth',block:'center'});
  el.classList.add('highlight');
  setTimeout(function(){el.classList.remove('highlight')},1500);
}

function fmtMeta(data){
  var p=[];
  if(data.model_used)p.push('<span class="meta-item"><span class="meta-label">Model:</span> <span class="meta-value">'+esc(data.model_used)+'</span></span>');
  if(data.latency_ms!=null){
    var lcls=data.latency_ms<2000?'color:#4caf50':data.latency_ms<5000?'color:#ffc107':'color:#e94560';
    var parts=data.latency_ms.toFixed(0)+'ms';
    if(data.retrieval_ms!=null||data.generation_ms!=null){
      parts+=' <span style="color:#666">('; var segs=[];
      if(data.retrieval_ms!=null)segs.push('retrieval '+data.retrieval_ms.toFixed(0)+'ms');
      if(data.generation_ms!=null)segs.push('LLM '+data.generation_ms.toFixed(0)+'ms');
      parts+=segs.join(' + ')+')</span>';}
    p.push('<span class="meta-item"><span class="meta-label">Latency:</span> <span class="meta-value" style="'+lcls+'">'+parts+'</span></span>');}
  if(data.tokens_used){var t=data.tokens_used;var total=t.total||((t.prompt||0)+(t.completion||0));
    p.push('<span class="meta-item"><span class="meta-label">Tokens:</span> <span class="meta-value">'+total+' <span style="color:#666">('+( t.prompt||0)+' in / '+(t.completion||0)+' out)</span></span></span>');}
  if(data.num_sources)p.push('<span class="meta-item"><span class="meta-label">Sources:</span> <span class="meta-value">'+data.num_sources+' chunks</span></span>');
  return p.length?'<div class="response-meta">'+p.join('')+'</div>':'';
}

function fmtCitations(citations){
  if(!citations||!citations.length)return '';
  var h='<div class="citations"><details open><summary>&#128218; Sources ('+citations.length+')</summary>';
  for(var i=0;i<citations.length;i++){
    var c=citations[i],pg=c.page_number?' p.'+c.page_number:'',
        sec=c.section_title?'<span class="citation-section"> &mdash; '+esc(c.section_title)+'</span>':'',
        sc=(c.relevance_score*100).toFixed(0),src;
    if(c.url)src='<a href="'+esc(c.url)+'" target="_blank" rel="noopener noreferrer">'+esc(c.filename)+pg+' &#x2197;</a>';
    else src='<span class="no-link">'+esc(c.filename)+pg+'</span>';
    h+='<div class="citation-item" data-cite-id="'+c.citation_id+'"><span class="cite-ref" style="cursor:default;font-size:11px">S'+c.citation_id+'</span><span class="citation-score">'+sc+'%</span><span class="citation-source">'+src+'</span>'+sec+'</div>';
  }
  h+='</details></div>';return h;
}

function fmtBenchmark(data){
  var h='<div class="benchmark-results"><h4>&#9889; Model Comparison</h4>';
  for(var i=0;i<data.results.length;i++){
    var e=data.results[i];
    if(e.error){h+='<div class="bench-entry"><div class="bench-model-name">'+esc(e.model)+'</div><div style="color:#e94560">Error: '+esc(e.error)+'</div></div>';continue}
    var tk=e.tokens_used||{},total=tk.total||((tk.prompt||0)+(tk.completion||0));
    h+='<div class="bench-entry"><div class="bench-model-name">'+esc(e.model)+'</div>';
    h+='<div class="bench-stats"><span>'+e.latency_ms+'ms</span> | <span>'+total+' tokens</span> ('+( tk.prompt||0)+' in / '+(tk.completion||0)+' out)</div>';
    h+='<div class="bench-answer">'+esc((e.answer||'').substring(0,300))+(e.answer&&e.answer.length>300?'...':'')+'</div></div>';
  }
  if(data.summary&&data.summary.models_compared){
    var s=data.summary;
    h+='<div class="bench-summary">&#127942; <strong>Fastest:</strong> '+esc(s.fastest_model)+' ('+s.fastest_latency_ms+'ms) &nbsp;|&nbsp; <strong>Cheapest:</strong> '+esc(s.cheapest_model)+' ('+s.cheapest_tokens+' tokens) &nbsp;|&nbsp; '+s.models_compared+' models compared</div>';
  }
  h+='</div>';return h;
}

async function send(){
  var text=inputEl.value.trim();if(!text)return;
  inputEl.value='';inputEl.style.height='auto';sendBtn.disabled=true;compareBtn.disabled=true;
  addMsg('user','<p>'+esc(text)+'</p>');
  var typing=showTyping();
  try{
    var body={query:text,top_k:5,generate_answer:true};
    if(currentModel)body.model=currentModel;
    var res=await fetch('/query',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    var data=await res.json();typing.remove();
    if(data.detail){addMsg('assistant','<p style="color:#e94560;">Error: '+esc(data.detail)+'</p>')}
    else{addMsg('assistant',fmtMd(data.answer||'No answer generated.')+fmtMeta(data)+fmtCitations(data.citations))}
  }catch(err){typing.remove();addMsg('assistant','<p style="color:#e94560;">Connection error: '+esc(err.message)+'</p>')}
  sendBtn.disabled=false;compareBtn.disabled=false;inputEl.focus();
}

async function compareModels(){
  var text=inputEl.value.trim();if(!text){alert('Type a question first');return}
  inputEl.value='';inputEl.style.height='auto';sendBtn.disabled=true;compareBtn.disabled=true;
  addMsg('user','<p>'+esc(text)+'</p>');
  var typing=showTyping();
  try{
    var res=await fetch('/benchmark',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:text,top_k:5})});
    var data=await res.json();typing.remove();
    if(data.detail){addMsg('assistant','<p style="color:#e94560;">Error: '+esc(data.detail)+'</p>')}
    else{addMsg('assistant',fmtBenchmark(data))}
  }catch(err){typing.remove();addMsg('assistant','<p style="color:#e94560;">Benchmark error: '+esc(err.message)+'</p>')}
  sendBtn.disabled=false;compareBtn.disabled=false;inputEl.focus();
}
</script>
</body>
</html>
